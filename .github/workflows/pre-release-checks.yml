name: Pre-release checks

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  pre-release:
    name: Run pre-release checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install tooling (flake8, black, pytest, mkdocs) and optional deps
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black pytest mkdocs pymodbus

      - name: Make scripts executable
        run: |
          if [ -d scripts ]; then chmod +x scripts/*.sh || true; fi

      - name: Run pre-release checks (strict)
        env:
          REPO_ROOT: ${{ github.workspace }}
        run: |
          # Use VERSION file if present; else pass manifest.json version as fallback
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION)
          else
            VERSION=$(python3 -c "import json,sys; print(json.load(open('custom_components/ha_atrea_recuperation/manifest.json')).get('version','0.0.0'))")
          fi
          echo "Running pre-release checks for version: $VERSION"
          scripts/pre_release_checks.sh "$VERSION" --strict
